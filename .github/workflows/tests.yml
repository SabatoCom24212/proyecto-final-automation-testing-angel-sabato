# Nombre del workflow
name: Automated Tests

# Activador: Se ejecuta en push y pull requests
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

# Permite cancelar ejecuciones previas del mismo workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python 3.13.7
      uses: actions/setup-python@v5
      with:
        python-version: '3.13.7'
        cache: 'pip'
    
    - name: Instalar dependencias del sistema y de Python
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl unzip xvfb libnss3-dev libxss1 libasound2t64 libatk-bridge2.0-0
        
    - name: Instalar Chrome y ChromeDriver
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: Verificar versión de Chrome
      run: |
        google-chrome --version
        which google-chrome
    
    - name: Instalar dependencias de Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verificar versión de Python
      run: |
        python --version
        pip --version
    
    - name: Crear directorios necesarios
      run: |
        mkdir -p reports logs screenshots
    
    - name: Ejecutar tests
      id: run_tests
      env:
        HEADLESS: true
        CI: true
        PYTHONPATH: ${{ github.workspace }}
      run: |
        # Verificar si el directorio tests existe
        if [ ! -d "tests" ]; then
          echo "Directorio 'tests' no encontrado. Creando estructura básica..."
          mkdir -p tests
          echo "import pytest" > tests/test_example.py
          echo "def test_example():" >> tests/test_example.py
          echo "    assert True" >> tests/test_example.py
        fi
        
        # Ejecutar tests SECUENCIALMENTE (sin -n auto)
        # Los tests se ejecutarán uno por uno en orden
        pytest \
          --junitxml=reports/junit.xml \
          --reruns 2 \
          --reruns-delay 1
        
        # Verificar si hay reports generados
        echo "=== Archivos en reports/ ==="
        ls -la reports/ || echo "No se pudo listar reports/"
    
    - name: Verificar resultados de tests
      if: always()
      run: |
        echo "=== Resumen del ejecutor ==="
        echo "Resultado del job: ${{ job.status }}"
        
        if [ ! -f reports/junit.xml ]; then
          echo "No se generó reporte JUnit"
          mkdir -p reports
          echo '<?xml version="1.0" encoding="utf-8"?><testsuites></testsuites>' > reports/junit.xml
        fi
    
    - name: Subir reportes de tests
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: |
          reports/
          logs/
          screenshots/
        retention-days: 30
        if-no-files-found: warn